name: Update-CI

on:
  schedule:
    - cron: 0 16 * * *
  watch:
    types: [started]
  #push:
  #  branches:
  #    - master

jobs:
  build:

    runs-on: ubuntu-18.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - uses: actions/checkout@master

    - name: Run generate script
      run: |
        latest_commit="$(curl -s https://github.com/Trojan-Plus-Group/trojan-plus/commits/master | grep -E '"oid"' | cut -b 44-50 | sed -n 1p)"
        sed -i '/PKG_VERSION:/d' ./trojan-plus/Makefile
        sed -i "9 a PKG_VERSION:=$latest_commit" ./trojan-plus/Makefile

    - name: Commit file
      run: |
        git config --global user.email simonsqiu@foxmail.com
        git config --global user.name SimonsQiu
        git add .
        git commit -m "Update `date +%Y/%m/%d\ %H:%M:%S\ %Z`" -a

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}

    - name: Cleanup Workflow Logs
      uses: Mattraks/delete-workflow-runs@main
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 1
